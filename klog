#!/bin/bash

# === klog ===
# Show logs for a Kubernetes pod or deployment by partial match
# Usage: klog <search-term> [-n namespace] [-t type]
# Defaults: namespace="default", type="pod"

SEARCH=""
NAMESPACE="default"
TYPE="pod"

# ANSI colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RESET='\033[0m'

# Parse args
while [[ $# -gt 0 ]]; do
  case $1 in
    -n|--namespace)
      NAMESPACE="$2"
      shift 2
      ;;
    -t|--type)
      TYPE="$2"
      shift 2
      ;;
    *)
      SEARCH="$1"
      shift
      ;;
  esac
done

if [[ -z "$SEARCH" ]]; then
  echo "Usage: klog <search-term> [-n namespace] [-t type]"
  exit 1
fi

echo "Searching for $TYPE(s) matching \"$SEARCH\" in namespace \"$NAMESPACE\"..."

MATCHES=($(kubectl get $TYPE -n "$NAMESPACE" --no-headers | awk '{print $1}' | grep "$SEARCH"))

if [[ ${#MATCHES[@]} -eq 0 ]]; then
  echo "No $TYPE found matching \"$SEARCH\"."
  exit 1
elif [[ ${#MATCHES[@]} -eq 1 ]]; then
  SELECTED="${MATCHES[0]}"
else
  echo "Multiple matches found:"
  for i in "${!MATCHES[@]}"; do
    echo " $((i+1))) ${MATCHES[$i]}"
  done
  read -rp "Select a number: " SELECTED_INDEX
  SELECTED="${MATCHES[$((SELECTED_INDEX-1))]}"
fi

echo "Showing logs for: $SELECTED"

LOG_CMD="kubectl logs $TYPE/$SELECTED -n $NAMESPACE --all-containers=true"

$LOG_CMD | while IFS= read -r line; do
  if [[ $line =~ \"time\":\"([^\"]+)\" ]]; then
    TIMESTAMP="${BASH_REMATCH[1]}"
  else
    TIMESTAMP=""
  fi

  if [[ $line =~ \"level\":\"([^\"]+)\" ]]; then
    LEVEL="${BASH_REMATCH[1]}"
  else
    LEVEL="UNKNOWN"
  fi

  case "$LEVEL" in
    INFO)
      COLOR=$GREEN
      ;;
    ERROR)
      COLOR=$RED
      ;;
    WARN|WARNING)
      COLOR=$YELLOW
      ;;
    *)
      COLOR=$RESET
      ;;
  esac

  if [[ $line =~ \"msg\":\"([^\"]+)\" ]]; then
    MSG="${BASH_REMATCH[1]}"
    echo -e "${COLOR}[${TIMESTAMP}] [$LEVEL] - $MSG${RESET}"
  else
    echo -e "${COLOR}${line}${RESET}"
  fi
done