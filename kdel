#!/bin/bash
# kubectl delete helper

# === DEFAULTS ===
NAMESPACE="default"
SEARCH=""

# === COLORS ===
BOLD='\033[1m'
RED='\033[0;31m'
GREEN='\033[0;32m'
RESET='\033[0m'

# === ARGUMENT PARSING ===
while [[ $# -gt 0 ]]; do
    case "$1" in
        -n|--namespace)
            shift
            NAMESPACE="$1"
            ;;
        *)
            SEARCH="$1"
            ;;
    esac
    shift
done

# === ASK IF MISSING SEARCH TERM ===
if [ -z "$SEARCH" ]; then
    read -p "Enter search string for pod: " SEARCH
fi

# === GET MATCHING PODS ===
MATCHES=($(kubectl get pods -n "$NAMESPACE" --no-headers | awk '{print $1}' | grep "$SEARCH"))
COUNT=${#MATCHES[@]}

select_pod() {
  echo "Multiple matches found:"
  for i in "${!MATCHES[@]}"; do
      printf " %2d) %s\n" $((i+1)) "${MATCHES[$i]}"
  done
  read -p "Select a pod number to delete: " SEL
  SEL_INDEX=$((SEL-1))
  if [[ $SEL_INDEX -ge 0 && $SEL_INDEX -lt $COUNT ]]; then
    POD_NAME="${MATCHES[$SEL_INDEX]}"
  else
    echo "Invalid selection."
    exit 1
  fi
}

if [ "$COUNT" -eq 0 ]; then
    echo "No pods found in namespace '${NAMESPACE}' matching '$SEARCH'"
    exit 1
elif [ "$COUNT" -eq 1 ]; then
    POD_NAME="${MATCHES[0]}"
else
    select_pod
fi

# === CONFIRMATION PROMPT ===
echo -e "${BOLD}Namespace:${RESET} $NAMESPACE"
echo -e "${RED}Delete pod:${RESET} $POD_NAME"
read -p "Are you sure? [y/N]: " CONFIRM
if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo -e "Deleting pod ${BOLD}${POD_NAME}${RESET}..."
    kubectl delete pod "$POD_NAME" -n "$NAMESPACE"
else
    echo "Aborted."
    exit 0
fi